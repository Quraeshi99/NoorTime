<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
    <title>{% block title %}NoorTime{% endblock title %} - Global</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <link rel="stylesheet" href="{{ url_for('static', filename='css/dist/style.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#6750A4">

    {% block head_extra %}{% endblock head_extra %}
</head>
<body class="bg-background text-on-background">

    <!-- Navigation Bar -->
    <nav class="bg-surface text-on-surface shadow-md sticky top-0 z-50 print:hidden border-b border-on-surface-variant/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="{{ url_for('main.index') }}" class="flex items-center text-xl font-bold text-on-surface hover:opacity-80 transition-opacity" aria-label="Home">
                        <span class="material-symbols-outlined">mosque</span>
                    </a>
                </div>
                <div class="flex-grow text-center">
                    <h1 class="text-xl font-bold">NoorTime</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" type="button" class="p-2 rounded-full hover:bg-on-surface-variant/10 transition-colors" aria-label="Toggle Theme">
                        <span class="material-symbols-outlined" id="theme-icon">light_mode</span>
                    </button>
                    <button id="settings-toggle" type="button" class="p-2 rounded-full hover:bg-on-surface-variant/10 transition-colors z-70" aria-label="Settings">
                        <span class="material-symbols-outlined">settings</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Overlay for dimmed background -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-75 hidden print:hidden"></div>

    <!-- Settings Panel (Side Drawer) -->
    <aside id="settings-panel" class="fixed top-0 left-0 h-full w-64 bg-surface text-on-surface shadow-lg z-80 transform -translate-x-full transition-transform duration-300 ease-in-out print:hidden">
        <div class="p-4">
            <h2 class="text-lg font-bold mb-4">Settings</h2>
            <nav>
                <ul>
                    <li><a href="{{ url_for('main.settings') }}#general" data-tab="general" class="flex items-center p-2 rounded-md hover:bg-on-surface-variant/10"><span class="material-symbols-outlined mr-2">tune</span>General</a></li>
                    <li><a href="{{ url_for('main.settings') }}#prayer-times" data-tab="prayer-times" class="flex items-center p-2 rounded-md hover:bg-on-surface-variant/10"><span class="material-symbols-outlined mr-2">timer</span>Prayer Times</a></li>
                    <li><a href="{{ url_for('main.settings') }}#profile" data-tab="profile" class="flex items-center p-2 rounded-md hover:bg-on-surface-variant/10"><span class="material-symbols-outlined mr-2">person</span>Profile</a></li>
                    <li><a href="#" class="flex items-center p-2 rounded-md hover:bg-on-surface-variant/10"><span class="material-symbols-outlined mr-2">info</span>About Us</a></li>
                </ul>
            </nav>
        </div>
        <div class="absolute bottom-0 w-full p-4 border-t border-on-surface-variant/10">
            <a href="{{ url_for('auth.logout') }}" class="flex items-center p-2 rounded-md hover:bg-on-surface-variant/10"><span class="material-symbols-outlined mr-2">logout</span>Logout</a>
            <footer class="text-center py-4 text-xs">
                NoorTime Â© <span id="currentYearFooter"></span>
            </footer>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-2 py-4 sm:px-4 sm:py-6">
        {% block content %}{% endblock content %}
    </main>

    <script>
        // Theme toggle script (remains unchanged)
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const htmlEl = document.documentElement;

        function updateTheme(isDark) {
            htmlEl.classList.toggle('dark', isDark);
            themeIcon.textContent = isDark ? 'dark_mode' : 'light_mode';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        const savedThemeIsDark = localStorage.getItem('theme') === 'dark';
        const osPrefersDark = !('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches;
        updateTheme(savedThemeIsDark || osPrefersDark);

        themeToggleBtn.addEventListener('click', () => {
            updateTheme(!htmlEl.classList.contains('dark'));
        });

        // --- SETTINGS PANEL LOGIC - COMPLETELY NEW ---
        const settingsToggleBtn = document.getElementById('settings-toggle');
        const settingsPanel = document.getElementById('settings-panel');
        const overlay = document.getElementById('overlay');

        function togglePanel(forceClose = false) {
            const isHidden = settingsPanel.classList.contains('-translate-x-full');
            if (forceClose || !isHidden) {
                settingsPanel.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                console.log('DEBUG: Panel closed.');
            } else {
                settingsPanel.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                console.log('DEBUG: Panel opened.');
            }
        }

        settingsToggleBtn.addEventListener('click', function (event) {
            event.stopPropagation(); // Crucial to prevent the document click listener from firing immediately
            console.log('DEBUG: Settings toggle button clicked.');
            togglePanel();
        });

        overlay.addEventListener('click', function () {
            console.log('DEBUG: Overlay clicked.');
            togglePanel(true); // Force close the panel
        });

        settingsPanel.addEventListener('click', function (event) {
            event.stopPropagation(); // Prevent clicks inside the panel from bubbling up to the overlay
            console.log('DEBUG: Click inside panel detected.');
        });

        document.getElementById('currentYearFooter').textContent = new Date().getFullYear();
    </script>

    {% block scripts %}{% endblock scripts %}
</body>
</html>